<div id="admin-panel">
    <h2><i data-feather="file-text"></i> Upload Document</h2>

    <div id="wallet-section">
      <button id="connect-btn" onclick="connectAdminWallet()">
        <i data-feather="link"></i>
        <span>Connect Wallet</span>
      </button>
      <span id="admin-wallet"></span>
    </div>

    <div id="loading-wallet" style="display:none" class="loading-state">
      <i data-feather="loader" class="spin"></i>
      <span>Connecting wallet...</span>
    </div>

    <form id="upload-form" style="display:none">
      <input type="file" id="document" required accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg">
      <textarea id="wallet-addresses" placeholder="Enter wallet addresses (one per line)&#10;0x1234...&#10;0x5678..." required></textarea>
      <button type="submit" id="upload-btn">
        <i data-feather="upload"></i>
        <span>Upload to Walrus</span>
      </button>
    </form>

    <div id="loading-upload" style="display:none" class="loading-state">
      <i data-feather="loader" class="spin"></i>
      <span>Uploading to Walrus...</span>
    </div>

    <div id="share-link" style="display:none">
      <h3><i data-feather="check-circle"></i> Share Link Ready</h3>
      <input type="text" id="link" readonly>
      <button onclick="copyLink()">
        <i data-feather="copy"></i>
        <span>Copy Link</span>
      </button>
    </div>
  </div>

  <script>
    let wallet = null

    async function connectAdminWallet() {
      const connectBtn = document.getElementById('connect-btn')
      const loadingWallet = document.getElementById('loading-wallet')
      const walletSection = document.getElementById('wallet-section')

      // Show loading state
      connectBtn.style.display = 'none'
      loadingWallet.style.display = 'block'

      try {
        wallet = await connectWallet()

        // Hide loading and show wallet info
        loadingWallet.style.display = 'none'
        document.getElementById('admin-wallet').textContent = wallet
        document.getElementById('admin-wallet').style.display = 'inline'
        document.getElementById('upload-form').style.display = 'block'

        // Update button to show connected state
        connectBtn.innerHTML = '<i data-feather="check"></i><span>Wallet Connected</span>'
        connectBtn.style.display = 'inline-block'
        connectBtn.disabled = true
        connectBtn.style.opacity = '0.7'

        feather.replace()
      } catch (error) {
        // Hide loading and show error
        loadingWallet.style.display = 'none'
        connectBtn.style.display = 'inline-block'
        alert('Failed to connect wallet: ' + error.message)
      }
    }

    function copyLink() {
      const linkInput = document.getElementById('link')
      linkInput.select()
      linkInput.setSelectionRange(0, 99999)

      try {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(linkInput.value).then(() => {
            alert('Link copied!')
          }).catch(() => {
            document.execCommand('copy')
            alert('Link copied!')
          })
        } else {
          const successful = document.execCommand('copy')
          if (successful) {
            alert('Link copied!')
          } else {
            alert('Copy failed. Please copy manually.')
          }
        }
      } catch (err) {
        alert('Copy not supported. Please copy manually.')
      }
    }

    window.addEventListener('DOMContentLoaded', function() {
      document.getElementById('upload-form').onsubmit = async function(e) {
        e.preventDefault()

        const uploadBtn = document.getElementById('upload-btn')
        const loadingUpload = document.getElementById('loading-upload')
        const uploadForm = document.getElementById('upload-form')

        // Show loading state
        uploadBtn.style.display = 'none'
        loadingUpload.style.display = 'block'

        try {
          const formData = new FormData()
          const fileInput = document.getElementById('document')
          const walletsText = document.getElementById('wallet-addresses').value

          formData.append('document', fileInput.files[0])
          formData.append('walletAddresses', walletsText)

          const response = await fetch('/upload', {
            method: 'POST',
            body: formData
          })

          const result = await response.json()

          // Hide loading state
          loadingUpload.style.display = 'none'

          if (result.success) {
            const shareLink = `${window.location.origin}/view/${result.shareId}`
            document.getElementById('link').value = shareLink
            document.getElementById('share-link').style.display = 'block'

            // Hide upload form after success
            uploadForm.style.display = 'none'

            feather.replace()
          } else {
            uploadBtn.style.display = 'inline-block'
            alert('Upload failed: ' + result.error)
          }
        } catch (error) {
          loadingUpload.style.display = 'none'
          uploadBtn.style.display = 'inline-block'
          alert('Upload error: ' + error.message)
        }
      }

      // Initialize icons
      feather.replace()
    })
  </script>