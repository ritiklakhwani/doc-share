

<div id="viewer">
  <h2><i data-feather="file-text"></i> Document Access</h2>

  <div id="access-info" class="access-card">
    <div id="loading-verification" class="loading-state">
      <i data-feather="loader" class="spin"></i>
      <span>Verifying access link...</span>
    </div>

    <div id="access-granted" style="display:none" class="success-state">
      <i data-feather="check-circle"></i>
      <h3>Access Granted</h3>
      <p id="file-info"></p>
      <p id="email-info"></p>
      <button id="view-file-btn" onclick="viewFile()">
        <i data-feather="eye"></i>
        <span>View File</span>
      </button>
    </div>

    <div id="access-denied" style="display:none" class="error-state">
      <i data-feather="x-circle"></i>
      <h3>Access Denied</h3>
      <p id="error-message"></p>
    </div>

    <div id="file-downloaded" style="display:none" class="success-state">
      <i data-feather="download"></i>
      <h3>File Downloaded</h3>
      <p>The file has been downloaded to your device. This link has now expired and cannot be used again.</p>
    </div>
  </div>
</div>

<script>
  const token = '<%= token %>'
  let fileInfo = null

  async function verifyAccess() {
    try {
      const response = await fetch('/verify-access', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ token })
      })

      const result = await response.json()

      document.getElementById('loading-verification').style.display = 'none'

      if (result.valid) {
        fileInfo = result
        document.getElementById('file-info').textContent = `File: ${result.fileName}`
        document.getElementById('email-info').textContent = `Authorized for: ${result.email}`
        document.getElementById('access-granted').style.display = 'block'
        feather.replace()
      } else {
        document.getElementById('error-message').textContent = result.error
        document.getElementById('access-denied').style.display = 'block'
        feather.replace()
      }
    } catch (error) {
      document.getElementById('loading-verification').style.display = 'none'
      document.getElementById('error-message').textContent = 'Failed to verify access: ' + error.message
      document.getElementById('access-denied').style.display = 'block'
      feather.replace()
    }
  }

  async function viewFile() {
    try {
      const viewBtn = document.getElementById('view-file-btn')
      const originalContent = viewBtn.innerHTML
      viewBtn.innerHTML = '<i data-feather="loader" class="spin"></i><span>Downloading...</span>'
      viewBtn.disabled = true
      feather.replace()

      // Trigger download
      const downloadLink = document.createElement('a')
      downloadLink.href = `/download/${token}`
      downloadLink.download = fileInfo.fileName
      document.body.appendChild(downloadLink)
      downloadLink.click()
      document.body.removeChild(downloadLink)

      // Show download complete state
      document.getElementById('access-granted').style.display = 'none'
      document.getElementById('file-downloaded').style.display = 'block'
      feather.replace()

    } catch (error) {
      const viewBtn = document.getElementById('view-file-btn')
      viewBtn.innerHTML = '<i data-feather="eye"></i><span>View File</span>'
      viewBtn.disabled = false
      feather.replace()
      alert('Download failed: ' + error.message)
    }
  }

  // Verify access on page load
  window.addEventListener('DOMContentLoaded', function() {
    verifyAccess()
    feather.replace()
  })
</script>